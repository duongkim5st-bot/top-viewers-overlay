<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Top Loyalty Overlay</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800;900&display=swap" rel="stylesheet">

<style>
:root{
  --w: 360px;

  --gold: #ffd24a;
  --silver: #e2e6ef;
  --bronze: #ffb37a;

  --text: #f2f4f7;
  --muted: #cfd2d8;
}

*{ box-sizing:border-box; }
body{
  margin:0;
  background: transparent;
  font-family: "Inter", system-ui, sans-serif;
  color: var(--text);
}

/* ===== CARD ===== */
.card{
  width: var(--w);
  background: rgba(0,0,0,.28);
  border-radius: 16px;
  border: 2px solid var(--gold);
  overflow: hidden;
}

/* ===== HEADER ===== */
.head{
  padding: 10px 12px;
  position: relative;
}

.twitchCorner{
  position:absolute;
  right: 10px;
  top: 10px;
  width: 28px;
  height: 28px;
  border-radius: 8px;
  background: rgba(145,70,255,.25);
  display:flex;
  align-items:center;
  justify-content:center;
}
.twitchCorner svg{ width:16px; height:16px; }

.title{
  font-size: 14px;
  font-weight: 900;
}
.title b{ color: var(--gold); }

.badges{
  margin-top: 6px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.badge{
  font-size: 10px;
  font-weight: 800;
  padding: 4px 8px;
  border-radius: 999px;
  background: rgba(255,255,255,.08);
}

/* ===== TABLE ===== */
.table{ padding: 8px 10px; }

.hdr{
  display:grid;
  grid-template-columns: 34px 1fr 70px 86px;
  font-size: 11px;
  font-weight: 900;
  color: var(--muted);
  align-items:center;
}
.hdr > div{ text-align:center; }
.hdr > div:nth-child(2){ text-align:left; } /* c·ªôt User canh tr√°i ƒë·ªÉ ƒë·ªçc d·ªÖ */

.prizeHdr{ text-align:center; }

.rows{
  display:flex;
  flex-direction:column;
  gap: 6px;
}

/* ===== ROW ===== */
.row{
  display:grid;
  grid-template-columns: 34px 1fr 70px 86px;
  align-items:center;
  padding: 8px;
  background: rgba(255,255,255,.06);
  border-radius: 10px;
}

/* canh gi·ªØa theo y√™u c·∫ßu */
.row > div{ text-align:center; }
.row > .name{ text-align:left; } /* n·∫øu b·∫°n mu·ªën User c≈©ng gi·ªØa: ƒë·ªïi left -> center */

/* ===== RANK ===== */
.rk{
  font-weight: 900;
  font-size: 13px;
}

/* ICON */
.medal{ font-size: 16px; }
.gold{ color: var(--gold); }
.silver{ color: var(--silver); }
.bronze{ color: var(--bronze); }

/* ===== NAME ===== */
.name{
  font-size: 13px;
  font-weight: 800;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ===== POINTS ===== */
.points{
  font-size: 11px;
  color: var(--muted);
  font-variant-numeric: tabular-nums;
}

/* ===== PRIZE ===== */
@keyframes prizeShift{
  0%{ background-position: 0% 50%; }
  100%{ background-position: 100% 50%; }
}

.prize{
  font-size: 12px;
  font-weight: 900;
  background: linear-gradient(90deg,#ffd24a,#19ffb4,#9146ff,#ffd24a);
  background-size: 300% 100%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: prizeShift 6s linear infinite;
}

.row.top1 .prize{ animation-duration: 2.5s; }
.row.top2 .prize{ animation-duration: 4s; }
.row.top3 .prize{ animation-duration: 4s; }
.row:not(.top1):not(.top2):not(.top3) .prize{ animation-duration: 7s; }

/* ===== MINI ALERT ===== */
@keyframes popIn{
  0%{ transform: translateY(-6px); opacity:0; }
  100%{ transform: translateY(0); opacity:1; }
}
.alertBar{
  display:none;
  margin-top: 6px;
  padding: 6px 8px;
  border-radius: 10px;
  background: rgba(255, 210, 74, .12);
  border: 1px solid rgba(255, 210, 74, .35);
  font-size: 11px;
  font-weight: 900;
  color: var(--text);
  animation: popIn .25s ease-out;
}
.alertBar.show{ display:block; }
.alertBar .muted{ color: var(--muted); font-weight: 800; }

/* ===== FOOTER ===== */
.foot{
  padding: 8px 10px;
  font-size: 10px;
  color: var(--muted);
  display:flex;
  justify-content:space-between;
}
</style>
</head>

<body>
<div class="card">

  <div class="head">
    <div class="twitchCorner">
      <svg viewBox="0 0 24 24">
        <path fill="#9146FF" d="M4 3h18v12l-5 5h-4l-2 2H8v-2H4V3z"/>
        <path fill="#fff" d="M6 5v12h4v2l2-2h5l3-3V5H6zm5 8H9V8h2v5zm5 0h-2V8h2v5z"/>
      </svg>
    </div>

    <div class="title">üèÜ <b>TOP LOYALTY</b> ‚Äì CURRENT SEASON</div>

    <div class="badges">
      <span class="badge">Current points</span>
      <span class="badge" id="resetText">Reset: 23:59 ng√†y 14 (VN)</span>
    </div>

    <div class="alertBar" id="alertBar">
      üö® <span id="alertName">‚Äî</span>
      <span class="muted">v∆∞·ª£t m·ªëc</span>
      <span id="alertMilestone">‚Äî</span> LP!
    </div>
  </div>

  <div class="table">
    <div class="hdr">
      <div>#</div>
      <div>User</div>
      <div>Points</div>
      <div class="prizeHdr">Prize (MCoins)</div>
    </div>
    <div class="rows" id="rows"></div>
  </div>

  <div class="foot">
    <span>Live ranking</span>
    <span id="updated">Updated: ‚Äî</span>
  </div>

</div>

<script>
/* ===== CONFIG ===== */
const WEBAPP_URL =
"https://script.google.com/macros/s/AKfycbyoYia8jIipN-Hq95blwQ8dkimXdy8uoNp_bvq1Ie1l7ZeQB0_QRMjBqsx7gwWg-kej8A/exec";
const REFRESH_MS = 15000;

// Reset text c·ªë ƒë·ªãnh theo y√™u c·∫ßu
document.getElementById("resetText").textContent = "Reset: 23:59 ng√†y 14 (VN)";

/* ALERT M·ªêC TOP 1 (POINTS) */
const MILESTONES = [5000, 10000, 20000, 50000, 100000];
let lastTop1Points = 0;
let nextMilestoneIndex = 0;

/* ===== DOM ===== */
const $rows = document.getElementById("rows");
const $updated = document.getElementById("updated");
const $alertBar = document.getElementById("alertBar");
const $alertName = document.getElementById("alertName");
const $alertMilestone = document.getElementById("alertMilestone");

/* ===== UTILS ===== */
const esc = s => String(s ?? "").replace(/[&<>"']/g, m =>
  ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])
);

function rankCell(rank){
  if(rank===1) return `<div class="rk medal gold">ü•á</div>`;
  if(rank===2) return `<div class="rk medal silver">ü•à</div>`;
  if(rank===3) return `<div class="rk medal bronze">ü•â</div>`;
  return `<div class="rk">${rank}</div>`;
}

function rowClass(rank){
  if(rank===1) return "row top1";
  if(rank===2) return "row top2";
  if(rank===3) return "row top3";
  return "row";
}

function showAlert(username, milestone){
  $alertName.textContent = username;
  $alertMilestone.textContent = Number(milestone).toLocaleString("en-US");
  $alertBar.classList.add("show");
  setTimeout(()=> $alertBar.classList.remove("show"), 6000);
}

function checkTop1Alert(username, points){
  if (nextMilestoneIndex >= MILESTONES.length) return;
  const milestone = MILESTONES[nextMilestoneIndex];
  if (points >= milestone && lastTop1Points < milestone) {
    console.log(`üö® TOP 1: ${username} v∆∞·ª£t m·ªëc ${milestone} points`);
    showAlert(username, milestone);
    nextMilestoneIndex++;
  }
  lastTop1Points = points;
}

/* ===== RENDER ===== */
function render(data){
  const list = data.top10 || [];
  $rows.innerHTML = "";

  list.forEach((x, i)=>{
    const rank = Number(x.rank||0);
    const name = esc(x.username||"-");
    const points = Number(x.total_points||0);
    const prize = Number(x.prize_mcoins||0).toLocaleString("en-US");

    if (i === 0) checkTop1Alert(name, points);

    const div = document.createElement("div");
    div.className = rowClass(rank);
    div.innerHTML = `
      ${rankCell(rank)}
      <div class="name">${name}</div>
      <div class="points">${points.toLocaleString("en-US")} LP</div>
      <div class="prize">${prize}</div>
    `;
    $rows.appendChild(div);
  });

  $updated.textContent = "Updated: " + (data.updated_at || "‚Äî");
}

async function load(){
  try{
    const res = await fetch(WEBAPP_URL, { cache:"no-store" });
    const data = await res.json();
    render(data);
  }catch(e){}
}

load();
setInterval(load, REFRESH_MS);
</script>
</body>
</html>
